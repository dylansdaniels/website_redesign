<html><body>
<div class='markdown-cell'>
	<h1>7.2 API Tutorial of Gamma Rhythms</h1>
<p>This example demonstrates how to simulate gamma rhythms via the well
established pyramidal-interneuron-gamma mechanisms [1], as detailed in
the <a href="">HNN GUI gamma tutorial</a>, using HNN-Core.</p>
<p>We recommend you first review the GUI tutorial. The workflow below
recreates weak gamma rhythms similar to Figures 4 and 5 of the GUI
tutorial, and strong gamma rhythms similar to Figure 12 and 13 in the
GUI tutorial.</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		# Authors: Mainak Jas <mjas@mgh.harvard.edu>
#          Sam Neymotin <samnemo@gmail.com>
#          Christopher Bailey <bailey.cj@gmail.com>

# sphinx_gallery_thumbnail_number = 2

import os.path as op
	</code>
</div>
<div class='markdown-cell'>
	<p>Let us import hnn_core</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		import hnn_core
import matplotlib.pyplot as plt
from hnn_core import simulate_dipole, read_params, jones_2009_model

hnn_core_root = op.dirname(hnn_core.__file__)
	</code>
</div>
<div class='markdown-cell'>
	<p>Read the parameter file and print the between-cell connectivity
parameters. Note that these are different compared with the 'default'
parameter set used in, e.g.,
<code>sphx_glr_auto_examples_workflows_plot_simulate_alpha.py</code>.</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		params_fname = op.join(
    hnn_core_root,
    'param',
    'gamma_L5weak_L2weak.json'
)
params = read_params(params_fname)
print(params['gbar_L*'])
	</code>
</div>
<div class='output-cell'><div class='output-label'>
	Out:
</div>
	<div class='output-code'>
		{
    &quot;gbar_L2Basket_L2Basket&quot;: 0.01,
    &quot;gbar_L2Basket_L2Pyr_gabaa&quot;: 0.007,
    &quot;gbar_L2Basket_L2Pyr_gabab&quot;: 0.0,
    &quot;gbar_L2Basket_L5Pyr&quot;: 0.0,
    &quot;gbar_L2Pyr_L2Basket&quot;: 0.0012,
    &quot;gbar_L2Pyr_L2Pyr_ampa&quot;: 0.0,
    &quot;gbar_L2Pyr_L2Pyr_nmda&quot;: 0.0,
    &quot;gbar_L2Pyr_L5Basket&quot;: 0.0,
    &quot;gbar_L2Pyr_L5Pyr&quot;: 0.0,
    &quot;gbar_L5Basket_L5Basket&quot;: 0.0075,
    &quot;gbar_L5Basket_L5Pyr_gabaa&quot;: 0.08,
    &quot;gbar_L5Basket_L5Pyr_gabab&quot;: 0.0,
    &quot;gbar_L5Pyr_L5Basket&quot;: 0.00091,
    &quot;gbar_L5Pyr_L5Pyr_ampa&quot;: 0.0,
    &quot;gbar_L5Pyr_L5Pyr_nmda&quot;: 0.0
}

	</div>
</div>
<div class='markdown-cell'>
	<p>We'll next add a tonic Poisson-distributed excitation to pyramidal
cells</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		net = jones_2009_model(params)

weights_ampa = {
    'L2_pyramidal': 0.0008,
    'L5_pyramidal': 0.0075,
}
synaptic_delays = {
    'L2_pyramidal': 0.1,
    'L5_pyramidal': 1.0,
}
rate_constant = {
    'L2_pyramidal': 140.0,
    'L5_pyramidal': 40.0,
}
net.add_poisson_drive(
    'poisson',
    rate_constant=rate_constant,
    weights_ampa=weights_ampa,
    location='proximal',
    synaptic_delays=synaptic_delays,
    event_seed=1349
)
	</code>
</div>
<div class='markdown-cell'>
	<p>And then we'll simulate the dipole moment in a single trial. (Note:
the default value used by <code>simulate_dipole</code> is
n_trials=params["N_trials"].)</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		dpls = simulate_dipole(
    net,
    tstop=250.,
)
scaling_factor = 30000
dpls = [dpl.scale(scaling_factor) for dpl in dpls]  # scale in place
	</code>
</div>
<div class='output-cell'><div class='output-label'>
	Out:
</div>
	<div class='output-code'>
		Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
[Done]
Trial 1: 0.03 ms...
Trial 1: 10.0 ms...
Trial 1: 20.0 ms...
Trial 1: 30.0 ms...
Trial 1: 40.0 ms...
Trial 1: 50.0 ms...
Trial 1: 60.0 ms...
Trial 1: 70.0 ms...
Trial 1: 80.0 ms...
Trial 1: 90.0 ms...
Trial 1: 100.0 ms...
Trial 1: 110.0 ms...
Trial 1: 120.0 ms...
Trial 1: 130.0 ms...
Trial 1: 140.0 ms...
Trial 1: 150.0 ms...
Trial 1: 160.0 ms...
Trial 1: 170.0 ms...
Trial 1: 180.0 ms...
Trial 1: 190.0 ms...
Trial 1: 200.0 ms...
Trial 1: 210.0 ms...
Trial 1: 220.0 ms...
Trial 1: 230.0 ms...
Trial 1: 240.0 ms...

	</div>
</div>
<div class='markdown-cell'>
	<p>Take a look at how different cell types respond to the exogenous
drive. Note the periodic firing pattern of all cell types. While the
basket cells fire relatively synchronously, the pyramidal cell
populations display a more varied pattern, in which only a fraction of
cells reach firing threshold.</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		_ = net.cell_response.plot_spikes_raster()

plt.show()
	</code>
</div>
<div class='output-cell'><div class='output-label'>
	Out:
</div>
	<div class='output-code'>
		&lt;Figure size 640x480 with 1 Axes&gt;
	</div>
</div>
<div class='output-cell'>
	<img src='output_nb_plot_simulate_gamma/fig_01.png'/>
</div>
<div class='markdown-cell'>
	<p>To confirm that the periodicity observed in the firing patterns
correspond to a population oscillation in the gamma-range, we can plot
the time-frequency representation together with the signal. Note that
the network requires some time to reach steady state. Hence, we omit the
first 50 ms in our analysis.</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		tmin = 50
trial_idx = 0  # pick first trial

# plot dipole time course and time-frequency
# representation in same figure
import numpy as np
import matplotlib.pyplot as plt

fig, axes = plt.subplots(
    nrows=2,
    ncols=1,
    sharex=True,
    figsize=(6, 6),
    constrained_layout=True,
)

dpls[trial_idx].plot(
    tmin=tmin,
    ax=axes[0],
    show=False,
)

# Create an fixed-step tiling of frequencies 
# from 20 to 100 Hz in steps of 1 Hz
freqs = np.arange(20., 100., 1.)
dpls[trial_idx].plot_tfr_morlet(
    freqs,
    n_cycles=7,
    tmin=tmin,
    ax=axes[1],
    show=False,
)

# adjust the bounds of the x axis in the spectrogram
axes[1].set_xlim(tmin, 250)

plt.show()
	</code>
</div>
<div class='output-cell'><div class='output-label'>
	Out:
</div>
	<div class='output-code'>
		&lt;Figure size 600x600 with 3 Axes&gt;
	</div>
</div>
<div class='output-cell'>
	<img src='output_nb_plot_simulate_gamma/fig_02.png'/>
</div>
<div class='markdown-cell'>
	<p>Now, let us try to re-run the simulation with a tonic bias applied to
the L5 Pyramidal cells. Notice that the oscillation waveform is more
regular, with less noise due to the fact that the tonic depolarization
dominates over the influence of the Poisson drive. By default, a tonic
bias is applied to the entire duration of the simulation.</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		net.add_tonic_bias(
    cell_type='L5_pyramidal',
    amplitude=6.,
)
dpls = simulate_dipole(
    net,
    tstop=250.,
    n_trials=1,
)
dpls = [dpl.scale(scaling_factor) for dpl in dpls]  # scale in place
	</code>
</div>
<div class='output-cell'><div class='output-label'>
	Out:
</div>
	<div class='output-code'>
		Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
[Done]
Trial 1: 0.03 ms...
Trial 1: 10.0 ms...
Trial 1: 20.0 ms...
Trial 1: 30.0 ms...
Trial 1: 40.0 ms...
Trial 1: 50.0 ms...
Trial 1: 60.0 ms...
Trial 1: 70.0 ms...
Trial 1: 80.0 ms...
Trial 1: 90.0 ms...
Trial 1: 100.0 ms...
Trial 1: 110.0 ms...
Trial 1: 120.0 ms...
Trial 1: 130.0 ms...
Trial 1: 140.0 ms...
Trial 1: 150.0 ms...
Trial 1: 160.0 ms...
Trial 1: 170.0 ms...
Trial 1: 180.0 ms...
Trial 1: 190.0 ms...
Trial 1: 200.0 ms...
Trial 1: 210.0 ms...
Trial 1: 220.0 ms...
Trial 1: 230.0 ms...
Trial 1: 240.0 ms...

	</div>
</div>
<div class='code-cell'>
	<code class='language-python'>
		_ = dpls[trial_idx].plot()

plt.show()
	</code>
</div>
<div class='output-cell'><div class='output-label'>
	Out:
</div>
	<div class='output-code'>
		&lt;Figure size 640x480 with 1 Axes&gt;
	</div>
</div>
<div class='output-cell'>
	<img src='output_nb_plot_simulate_gamma/fig_03.png'/>
</div>
<div class='markdown-cell'>
	<p>Notice that the Layer 5 pyramidal neurons now fire nearly
synchronously, leading to a synchronous activation of the inhibitory
basket neurons, resulting in a low-latency IPSP back onto the pyramidal
cells. The duration of the IPSP is ~20 ms, after which the combined
effect of the tonic bias and Poisson drive is to bring the pyramidal
cells back to firing threshold, creating a ~50 Hz PING rhythm. This type
of synchronous rhythm is sometimes referred to as “strong” PING.</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		_ = net.cell_response.plot_spikes_raster()

plt.show()
	</code>
</div>
<div class='output-cell'><div class='output-label'>
	Out:
</div>
	<div class='output-code'>
		&lt;Figure size 640x480 with 1 Axes&gt;
	</div>
</div>
<div class='output-cell'>
	<img src='output_nb_plot_simulate_gamma/fig_04.png'/>
</div>
<div class='markdown-cell'>
	<p>Although the simulated dipole signal demonstrates clear periodicity,
its frequency is lower compared with the "weak" PING simulation
above.</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		from hnn_core.viz import plot_psd
_ = plot_psd(
    dpls[trial_idx],
    fmin=20.,
    fmax=100.,
    tmin=tmin,
)

plt.show()
	</code>
</div>
<div class='output-cell'><div class='output-label'>
	Out:
</div>
	<div class='output-code'>
		&lt;Figure size 640x480 with 1 Axes&gt;
	</div>
</div>
<div class='output-cell'>
	<img src='output_nb_plot_simulate_gamma/fig_05.png'/>
</div>
<div class='markdown-cell'>
	<p>Finally, we demonstrate the mechanistic link between PING and the
GABAA decay time constant (<code>tau2</code>). Using the same
network/drive configuration as before, we decrease <code>tau2</code>
from 5 to 2 ms.</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		net.cell_types['L5_pyramidal'].synapses['gabaa']['tau2'] = 2

dpls = simulate_dipole(
    net,
    tstop=250.,
    n_trials=1,
)
dpls = [dpl.scale(scaling_factor) for dpl in dpls]  # scale in place
	</code>
</div>
<div class='output-cell'><div class='output-label'>
	Out:
</div>
	<div class='output-code'>
		Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
[Done]
Trial 1: 0.03 ms...
Trial 1: 10.0 ms...
Trial 1: 20.0 ms...
Trial 1: 30.0 ms...
Trial 1: 40.0 ms...
Trial 1: 50.0 ms...
Trial 1: 60.0 ms...
Trial 1: 70.0 ms...
Trial 1: 80.0 ms...
Trial 1: 90.0 ms...
Trial 1: 100.0 ms...
Trial 1: 110.0 ms...
Trial 1: 120.0 ms...
Trial 1: 130.0 ms...
Trial 1: 140.0 ms...
Trial 1: 150.0 ms...
Trial 1: 160.0 ms...
Trial 1: 170.0 ms...
Trial 1: 180.0 ms...
Trial 1: 190.0 ms...
Trial 1: 200.0 ms...
Trial 1: 210.0 ms...
Trial 1: 220.0 ms...
Trial 1: 230.0 ms...
Trial 1: 240.0 ms...

	</div>
</div>
<div class='markdown-cell'>
	<p>This change will shorten the effective refactory period between L5
pyramidal cell spikes and increase the PING frequency from ~50 to ~65
Hz, as seen in the plots below</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		fig, axes = plt.subplots(
    nrows=3,
    ncols=1,
    sharex=True,
    figsize=(6, 6),
    constrained_layout=True,
)

dpls[trial_idx].plot(
    ax=axes[0],
    show=False,
)

net.cell_response.plot_spikes_raster(
    ax=axes[1],
    show=False,
)

dpls[trial_idx].plot_tfr_morlet(
    freqs,
    n_cycles=7,
    tmin=tmin,
    ax=axes[2],
    show=False,
)

# adjust the bounds of the x axis in the spectrogram
axes[2].set_xlim(tmin, 250)

plt.show()
	</code>
</div>
<div class='output-cell'><div class='output-label'>
	Out:
</div>
	<div class='output-code'>
		&lt;Figure size 600x600 with 4 Axes&gt;
	</div>
</div>
<div class='output-cell'>
	<img src='output_nb_plot_simulate_gamma/fig_06.png'/>
</div>
<div class='markdown-cell'>
	<h2>References</h2>
<p>[1] Lee, S. &amp; Jones, S. R. Distinguishing mechanisms of gamma
frequency oscillations in human current source signals using a
computational model of a laminar neocortical network. Frontiers in human
neuroscience (2013)</p>

</div>
</body></html>