<html><body>
<div class='markdown-cell'>
	<h1>4.8: Parallelism: Using the MPI backend</h1>
<p>This example demonstrates how to use the MPI backend for simulating
dipoles using <code>hnn_core</code>.</p>
<p><code>hnn_core</code> can take advantage of MPI libraries such as <a
href="https://www.open-mpi.org/">OpenMPI</a> to run a
<strong>single</strong> simulation using <strong>multiple</strong> CPU
processors. MPI lets you divide parts of your simulated network across
CPUs while allowing the CPUs to "talk" to each other, and can therefore
enable <em>significant</em> speed-up of individual simulations.</p>
<p>Note that to use MPI parallelism, you need either the
<code>conda</code> install <strong>or</strong> the
<code>MPI Installation</code> dependencies described <a
href="https://jonescompneurolab.github.io/hnn-core/dev/install.html">in
our Installation Guide here</a>.</p>
<p>Note that MPI parallelism is distinct from <code>hnn_core</code>'s
use of <a
href="https://jonescompneurolab.github.io/textbook/content/04_using_hnn/parallelism_joblib.html">Joblib
parallelism, which can be found here</a>.</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		# Authors: Mainak Jas <mjas@mgh.harvard.edu>
#          Blake Caldwell <blake_caldwell@brown.edu>
#          Austin Soplata <austin_soplata@brown.edu>
	</code>
</div>
<div class='markdown-cell'>
	<p>Let us import what we need from <code>hnn_core</code>:</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		import matplotlib.pyplot as plt

from hnn_core import simulate_dipole, jones_2009_model
from hnn_core.viz import plot_dipole
	</code>
</div>
<div class='markdown-cell'>
	<p>Following our <a
href="https://jonescompneurolab.github.io/textbook/content/06_alpha_beta/api.html">Alpha
example</a>, we will create our network and add a ~10 Hz "bursty"
drive:</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		net = jones_2009_model()

weights_ampa = {'L2_pyramidal': 5.4e-5, 'L5_pyramidal': 5.4e-5}
net.add_bursty_drive(
    'bursty', tstart=50., burst_rate=10, burst_std=20., numspikes=2,
    spike_isi=10, n_drive_cells=10, location='distal',
    weights_ampa=weights_ampa, event_seed=278)
	</code>
</div>
<div class='markdown-cell'>
	<p>Finally, we will simulate using the <a
href="https://jonescompneurolab.github.io/hnn-core/stable/generated/hnn_core.parallel_backends.MPIBackend.html#hnn_core.parallel_backends.MPIBackend"><code>MPIBackend</code>
class</a>. This will start the simulation across the number of
processors (cores) specified by <code>n_procs</code> using MPI.</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		from hnn_core import MPIBackend

with MPIBackend(n_procs=4, mpi_cmd='mpiexec'):
    dpls = simulate_dipole(net, tstop=210., n_trials=1)
	</code>
</div>
<div class='output-cell'><div class='output-label'>
	Out:
</div>
	<div class='output-code'>
		MPI will run 1 trial(s) sequentially by distributing network neurons over 4 processes.
/opt/anaconda3/envs/website-redesign-mpi/bin/nrniv:10: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import working_set
/opt/anaconda3/envs/website-redesign-mpi/bin/nrniv:10: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import working_set
/opt/anaconda3/envs/website-redesign-mpi/bin/nrniv:10: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import working_set
/opt/anaconda3/envs/website-redesign-mpi/bin/nrniv:10: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import working_set
numprocs=4
Loading custom mechanism files from /opt/anaconda3/envs/website-redesign-mpi/lib/python3.12/site-packages/hnn_core/mod/arm64/.libs/libnrnmech.so
Building the NEURON model
Loading custom mechanism files from /opt/anaconda3/envs/website-redesign-mpi/lib/python3.12/site-packages/hnn_core/mod/arm64/.libs/libnrnmech.so
Loading custom mechanism files from /opt/anaconda3/envs/website-redesign-mpi/lib/python3.12/site-packages/hnn_core/mod/arm64/.libs/libnrnmech.so
Loading custom mechanism files from /opt/anaconda3/envs/website-redesign-mpi/lib/python3.12/site-packages/hnn_core/mod/arm64/.libs/libnrnmech.so
[Done]
Trial 1: 0.03 ms...
Trial 1: 10.0 ms...
Trial 1: 20.0 ms...
Trial 1: 30.0 ms...
Trial 1: 40.0 ms...
Trial 1: 50.0 ms...
Trial 1: 60.0 ms...
Trial 1: 70.0 ms...
Trial 1: 80.0 ms...
Trial 1: 90.0 ms...
Trial 1: 100.0 ms...
Trial 1: 110.0 ms...
Trial 1: 120.0 ms...
Trial 1: 130.0 ms...
Trial 1: 140.0 ms...
Trial 1: 150.0 ms...
Trial 1: 160.0 ms...
Trial 1: 170.0 ms...
Trial 1: 180.0 ms...
Trial 1: 190.0 ms...
Trial 1: 200.0 ms...

	</div>
</div>
<div class='code-cell'>
	<code class='language-python'>
		plot_dipole(dpls, show=False)
plt.show()
	</code>
</div>
<div class='output-cell'><div class='output-label'>
	Out:
</div>
	<div class='output-code'>
		&lt;Figure size 640x480 with 1 Axes&gt;
	</div>
</div>
<div class='output-cell'>
	<img src='output_nb_parallelism_mpi_notebook/fig_01.png'/>
</div>
</body></html>