<html><body>
<div class='markdown-cell'>
	<h1>7.7: Parallelism: Using the Joblib backend</h1>
<p>This example demonstrates how to use the Joblib backend for
simulating dipoles using <code>hnn_core</code>.</p>
<p><code>hnn_core</code> can take advantage of <a
href="https://joblib.readthedocs.io/en/stable/">the Joblib library</a>
to run <strong>multiple</strong> independent simulations simultaneously
across <strong>multiple</strong> CPU processors. This is an example of
<a
href="https://en.wikipedia.org/wiki/Embarrassingly_parallel">"embarrassingly
parallel" processing jobs</a>. In HNN, this is commonly done if you want
to run many "trials" of the same simulation. Since each trial simulation
is fully independent of the other trial simulations, each trial
simulation can be run on its own CPU core. Joblib parallelism is
particularly useful if you are using <a
href="https://jonescompneurolab.github.io/textbook/content/04_using_hnn/batch_simulation.html">batch
simulation to explore parameter spaces</a>.</p>
<p>Note that to use Joblib parallelism, you need either the
<code>conda</code> install or the <code>Joblib Installation</code>
dependencies described <a
href="https://jonescompneurolab.github.io/hnn-core/dev/install.html">in
our Installation Guide here</a>.</p>
<p>Note that Joblib parallelism is distinct from <code>hnn_core</code>'s
use of <a
href="https://jonescompneurolab.github.io/textbook/content/04_using_hnn/parallelism_mpi.html">MPI
parallelism, which can be found here</a>.</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		# Authors: Mainak Jas <mjas@mgh.harvard.edu>
#          Blake Caldwell <blake_caldwell@brown.edu>
#          Austin Soplata <austin_soplata@brown.edu>
	</code>
</div>
<div class='markdown-cell'>
	<p>Let us import what we need from <code>hnn_core</code>:</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		import matplotlib.pyplot as plt

from hnn_core import simulate_dipole, jones_2009_model
from hnn_core.viz import plot_dipole
	</code>
</div>
<div class='markdown-cell'>
	<p>Following our <a
href="https://jonescompneurolab.github.io/textbook/content/06_alpha_beta/api.html">Alpha
example</a>, we will create our network and add a ~10 Hz "bursty"
drive:</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		net = jones_2009_model()

weights_ampa = {'L2_pyramidal': 5.4e-5, 'L5_pyramidal': 5.4e-5}
net.add_bursty_drive(
    'bursty', tstart=50., burst_rate=10, burst_std=20., numspikes=2,
    spike_isi=10, n_drive_cells=10, location='distal',
    weights_ampa=weights_ampa, event_seed=278)
	</code>
</div>
<div class='markdown-cell'>
	<p>Finally, we will simulate using the <a
href="https://jonescompneurolab.github.io/hnn-core/dev/generated/hnn_core.parallel_backends.JoblibBackend.html#hnn_core.parallel_backends.JoblibBackend"><code>JoblibBackend</code>
class</a>. You can control the number of CPU cores to use via
<code>n_jobs</code>, while the number of total trials to be run can be
specified by <code>n_trials</code>. Note that these numbers do NOT have
to match: you can ask for more trials than there are jobs available, and
Joblib will simply execute later jobs after the first batch has
completed.</p>

</div>
<div class='code-cell'>
	<code class='language-python'>
		from hnn_core import JoblibBackend

with JoblibBackend(n_jobs=4):
    dpls = simulate_dipole(net, tstop=210., n_trials=6)
	</code>
</div>
<div class='output-cell'><div class='output-label'>
	Out:
</div>
	<div class='output-code'>
		Joblib will run 6 trial(s) in parallel by distributing trials over 4 jobs.
Building the NEURON model
Building the NEURON model
Loading custom mechanism files from /opt/anaconda3/envs/website-redesign-mpi/lib/python3.12/site-packages/hnn_core/mod/arm64/.libs/libnrnmech.so
Building the NEURON model
Loading custom mechanism files from /opt/anaconda3/envs/website-redesign-mpi/lib/python3.12/site-packages/hnn_core/mod/arm64/.libs/libnrnmech.so
Building the NEURON model
[Done]
Trial 2: 0.03 ms...
[Done]
Trial 4: 0.03 ms...
[Done]
[Done]
Trial 3: 0.03 ms...
Trial 1: 0.03 ms...
Trial 2: 10.0 ms...
Trial 4: 10.0 ms...
Trial 1: 10.0 ms...
Trial 3: 10.0 ms...
Trial 2: 20.0 ms...
Trial 4: 20.0 ms...
Trial 3: 20.0 ms...
Trial 1: 20.0 ms...
Trial 2: 30.0 ms...
Trial 4: 30.0 ms...
Trial 3: 30.0 ms...
Trial 1: 30.0 ms...
Trial 2: 40.0 ms...
Trial 4: 40.0 ms...
Trial 3: 40.0 ms...
Trial 1: 40.0 ms...
Trial 2: 50.0 ms...
Trial 4: 50.0 ms...
Trial 3: 50.0 ms...
Trial 1: 50.0 ms...
Trial 2: 60.0 ms...
Trial 4: 60.0 ms...
Trial 3: 60.0 ms...
Trial 1: 60.0 ms...
Trial 2: 70.0 ms...
Trial 4: 70.0 ms...
Trial 3: 70.0 ms...
Trial 1: 70.0 ms...
Trial 2: 80.0 ms...
Trial 4: 80.0 ms...
Trial 3: 80.0 ms...
Trial 1: 80.0 ms...
Trial 2: 90.0 ms...
Trial 4: 90.0 ms...
Trial 3: 90.0 ms...
Trial 1: 90.0 ms...
Trial 2: 100.0 ms...
Trial 4: 100.0 ms...
Trial 3: 100.0 ms...
Trial 1: 100.0 ms...
Trial 2: 110.0 ms...
Trial 4: 110.0 ms...
Trial 3: 110.0 ms...
Trial 1: 110.0 ms...
Trial 2: 120.0 ms...
Trial 4: 120.0 ms...
Trial 3: 120.0 ms...
Trial 1: 120.0 ms...
Trial 2: 130.0 ms...
Trial 4: 130.0 ms...
Trial 3: 130.0 ms...
Trial 1: 130.0 ms...
Trial 4: 140.0 ms...
Trial 2: 140.0 ms...
Trial 3: 140.0 ms...
Trial 1: 140.0 ms...
Trial 4: 150.0 ms...
Trial 2: 150.0 ms...
Trial 3: 150.0 ms...
Trial 1: 150.0 ms...
Trial 2: 160.0 ms...
Trial 4: 160.0 ms...
Trial 3: 160.0 ms...
Trial 1: 160.0 ms...
Trial 4: 170.0 ms...
Trial 2: 170.0 ms...
Trial 3: 170.0 ms...
Trial 1: 170.0 ms...
Trial 4: 180.0 ms...
Trial 2: 180.0 ms...
Trial 3: 180.0 ms...
Trial 1: 180.0 ms...
Trial 4: 190.0 ms...
Trial 2: 190.0 ms...
Trial 3: 190.0 ms...
Trial 1: 190.0 ms...
Trial 4: 200.0 ms...
Trial 2: 200.0 ms...
Trial 3: 200.0 ms...
Trial 1: 200.0 ms...
Building the NEURON model
Building the NEURON model
[Done]
[Done]
Trial 6: 0.03 ms...
Trial 5: 0.03 ms...
Trial 6: 10.0 ms...
Trial 5: 10.0 ms...
Trial 6: 20.0 ms...
Trial 5: 20.0 ms...
Trial 6: 30.0 ms...
Trial 5: 30.0 ms...
Trial 6: 40.0 ms...
Trial 5: 40.0 ms...
Trial 6: 50.0 ms...
Trial 5: 50.0 ms...
Trial 6: 60.0 ms...
Trial 5: 60.0 ms...
Trial 6: 70.0 ms...
Trial 5: 70.0 ms...
Trial 6: 80.0 ms...
Trial 5: 80.0 ms...
Trial 6: 90.0 ms...
Trial 5: 90.0 ms...
Trial 6: 100.0 ms...
Trial 5: 100.0 ms...
Trial 6: 110.0 ms...
Trial 5: 110.0 ms...
Trial 6: 120.0 ms...
Trial 5: 120.0 ms...
Trial 6: 130.0 ms...
Trial 5: 130.0 ms...
Trial 6: 140.0 ms...
Trial 5: 140.0 ms...
Trial 6: 150.0 ms...
Trial 5: 150.0 ms...
Trial 6: 160.0 ms...
Trial 5: 160.0 ms...
Trial 6: 170.0 ms...
Trial 5: 170.0 ms...
Trial 6: 180.0 ms...
Trial 5: 180.0 ms...
Trial 6: 190.0 ms...
Trial 5: 190.0 ms...
Trial 6: 200.0 ms...
Trial 5: 200.0 ms...

	</div>
</div>
<div class='code-cell'>
	<code class='language-python'>
		plot_dipole(dpls, show=False)
plt.show()
	</code>
</div>
<div class='output-cell'><div class='output-label'>
	Out:
</div>
	<div class='output-code'>
		&lt;Figure size 640x480 with 1 Axes&gt;
	</div>
</div>
<div class='output-cell'>
	<img src='output_nb_parallelism_joblib_notebook/fig_01.png'/>
</div>
</body></html>