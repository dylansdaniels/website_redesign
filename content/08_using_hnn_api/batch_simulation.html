<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HNN Textbook</title>
    <!-- <base href="/textbook/"> -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/styles.css">
</head>
<body>

	<div id="mySidebar" class="sidebar">
		<div class="navbar-header">
		<a>
			Human Neocortical Neurosolver
		</a>
		<br>
			<svg class="collapse-icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
				<path d="M9 9H4v1h5V9z"/>
				<path fill-rule="evenodd" clip-rule="evenodd" d="M5 3l1-1h7l1 1v7l-1 1h-2v2l-1 1H3l-1-1V6l1-1h2V3zm1 2h4l1 1v4h2V3H6v2zm4 1H3v7h7V6z"/>
			</svg>
		</div>
		<a href="/textbook/content/preface.html">Preface</a>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				1. Getting Started
			</a>
			<div class="submenu">
				<a href="/textbook/content/01_getting_started/challenge.html">1.1 Introducing HNN</a>
				<a href="/textbook/content/01_getting_started/template_model.html">1.2 Template Model</a>
				<a href="/textbook/content/01_getting_started/installation.html">1.3 Installation</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				2. Model Assumptions
			</a>
			<div class="submenu">
				<a href="/textbook/content/03_model_assumptions/cortical_column_structure.html">2.1 Cortical Column Structure</a>
				<a href="/textbook/content/03_model_assumptions/primary_electric_currents.html">2.2 Primary Electrical Currents</a>
				<a href="/textbook/content/03_model_assumptions/neurons_morphology_and_physiology.html">2.3 Neurons: Morphology and Physiology</a>
				<a href="/textbook/content/03_model_assumptions/synaptic_connectivity.html">2.4 Synaptic Connectivity</a>
				<a href="/textbook/content/03_model_assumptions/evoked_and_rhythmic_driving_inputs.html">2.5 Evoked and Rhythmic Driving Inputs</a>
				<a href="/textbook/content/03_model_assumptions/tonic_and_noisy_driving_inputs.html">2.6 Tonic and Noisy Driving Inputs</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				3. Using the HNN GUI
			</a>
			<div class="submenu">
				<a href="/textbook/content/04_using_hnn_gui/gui_quickstart.html">3.1 GUI Quickstart</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				4. Simulating ERPs
			</a>
			<div class="submenu">
				<a href="/textbook/content/05_erps/erps_in_gui.html">4.1 GUI Tutorial of ERPs Simulation</a>
				<a href="/textbook/content/05_erps/hnn_core.html">4.2 API Tutorial of ERPs Simulation</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				5. Simulating Alpha/Beta Rhythms
			</a>
			<div class="submenu">
				<a href="/textbook/content/06_alpha_beta/gui.html">5.1 GUI Tutorial of Alpha/Beta Rhythms</a>
				<a href="/textbook/content/06_alpha_beta/api.html">5.2 API Tutorial of Alpha/Beta Rhythms</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				6. Simulating Gamma Rhythms
			</a>
			<div class="submenu">
				<a href="/textbook/content/07_gamma/gamma_in_gui.html">6.1 GUI Tutorial of Gamma Rhythms</a>
				<a href="/textbook/content/07_gamma/gamma_in_api.html">6.2 API Tutorial of Gamma Rhythms</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				7. Using the HNN API
			</a>
			<div class="submenu">
				<a href="/textbook/content/08_using_hnn_api/plot_firing_pattern.html">7.1 Plot Firing Pattern</a>
				<a href="/textbook/content/08_using_hnn_api/record_and_plot_extracellular_potentials.html">7.2 Record & Plot Extracellular Potentials</a>
				<a href="/textbook/content/08_using_hnn_api/modifying_local_connectivity.html">7.3 Modifying Local Connectivity</a>
				<a href="/textbook/content/08_using_hnn_api/animating_hnn_simulations.html">7.4 Animating HNN Simulations</a>
				<a href="/textbook/content/08_using_hnn_api/batch_simulation.html">7.5 Batch Simulation</a>
				<a href="/textbook/content/08_using_hnn_api/simulate_beta_modulated_erp.html">7.6 Simulate Beta-modulated ERP</a>
				<a href="/textbook/content/08_using_hnn_api/parallelism_joblib.html">7.7 Parallelism: Joblib</a>
				<a href="/textbook/content/08_using_hnn_api/parallelism_mpi.html">7.8 Parallelism: MPI</a>
				<a href="/textbook/content/08_using_hnn_api/optimize_simulated_evoked_response_parameters.html">7.9 Optimize simulated evoked response parameters</a>
				<a href="/textbook/content/08_using_hnn_api/optimize_simulated_rhythmic_response_parameters.html">7.10 Optimize simulated rhythmic response parameters</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				8. From Data to Simulation
			</a>
			<div class="submenu">
				<a href="/textbook/content/09_data_to_simulation/from_meg_to_hnn.html">8.1 From MEG sensor-space data to HNN simulation</a>
			</div>
		</div>
	<div style='height: 30px;'></div>
	</div>


    <div class="topbar">
        
        <!-- Topbar menu -->
        <div class="menu-container">
            <div class="menu-icons">
                <button class="openbtn" onclick="toggleNav()">
                    â˜°
                </button>
                <a href="" class="home-link">
                    <div class="home-icon-container">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24" 
                            height="24"
                            viewBox="0 0 24 24" 
                            class="home-icon">
                            <path
                                d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"
                            />
                        </svg>
                    </div>
                </a>
                <button class="theme-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                        <path d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zm224 0a128 128 0 1 0 -256 0 128 128 0 1 0 256 0z"></path>
                    </svg>
                </button>
                <div class="dropdown">
                    <button 
                        id="dropdownButton" 
                        class="dropdown-button">
                            <img
                                src="/textbook/content/assets/icons/fontsize.png"
                                alt="fontsize"
                            />
                    </button>
                    <div class="dropdown-content">
                        <button 
                            class="fontsize-btn" 
                            onclick="decreaseFontSize()">
                            <img
                                src="/textbook/content/assets/icons/fontminus.png"
                                alt="fontminus"
                            />
                        </button>
                        <button 
                            class="fontsize-btn" 
                            onclick="increaseFontSize()">
                            <img
                                src="/textbook/content/assets/icons/fontplus.png"
                                alt="fontplus"
                            />
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Topbar image -->
        <div class="topbar-logo-container">
            <img 
                id="topbar-logo"
                src="https://raw.githubusercontent.com/jonescompneurolab/jones-website/master/images/frontpage/logos/logo-hnn-medium.png"
            />
        </div>

        <!-- Right side of topbar -->
        <div class="socials-container">
            <div class="social-icons">
                <a 
                    href="https://github.com/jonescompneurolab/hnn-core" 
                    target="_blank" 
                    aria-label="GitHub">
                    <img 
                        src="/textbook/content/assets/icons/github.png"
                        alt="GitHub">
                </a>
                <a 
                    href="https://bsky.app/profile/hnnsolver.bsky.social" 
                    target="_blank"
                    aria-label="BlueSky">
                    <img 
                        src="/textbook/content/assets/icons/bluesky.png"
                        alt="BlueSky">
                </a>
                <a 
                    href="https://www.linkedin.com/company/human-neocortical-neurosolver/" 
                    target="_blank"
                    aria-label="LinkedIn">
                    <img 
                        src="/textbook/content/assets/icons/linkedin.png"
                        alt="LinkedIn">
                </a>
            </div>
        </div>
    </div>

    <div id="main">
    <div id="content-wrapper">
    <div id="content">

<!--
# Title: 7.5 Batch Simulation
# Updated: 2025-02-04
#
# Contributors:
    # Dylan Daniels
-->

        <div class="notebook-download-wrapper">
            <a href='batch_simulation_notebook.ipynb' download>
                <button class="notebook-download">
                    <svg xmlns="http://www.w3.org/2000/svg" 
                        width="20" height="20" viewBox="0 0 24 24" fill="none" 
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    <span style="width: 8px"></span>
                    <span>Download Notebook</span>
                </button>
            </a>
        </div>

    
<div class='markdown-cell'>
    <h1>7.5: Batch Simulation</h1>
<p>This example shows how to do batch simulations in HNN-core, allowing
users to efficiently run multiple simulations with different parameters
for comprehensive analysis.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        # Authors: Abdul Samad Siddiqui <abdulsamadsid1@gmail.com>
#          Nick Tolley <nicholas_tolley@brown.edu>
#          Ryan Thorpe <ryan_thorpe@brown.edu>
#          Mainak Jas <mjas@mgh.harvard.edu>
#
# This project was supported by Google Summer of Code (GSoC) 2024.
    </code>
</div>
<div class='markdown-cell'>
    <p>Let us import <code>hnn_core</code>.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        import matplotlib.pyplot as plt
import numpy as np
from hnn_core.batch_simulate import BatchSimulate
from hnn_core import jones_2009_model

# The number of cores may need modifying depending on your current machine.
n_jobs = 4
    </code>
</div>
<div class='markdown-cell'>
    <p>The <code>add_evoked_drive</code> function simulates external input
to the network, mimicking sensory stimulation or other external
events.</p>
<ul>
<li><code>evprox</code> indicates a proximal drive, targeting dendrites
near the cell bodies.</li>
<li><code>mu=40</code> and <code>sigma=5</code> define the timing (mean
and spread) of the input.</li>
<li><code>weights_ampa</code> and <code>synaptic_delays</code> control
the strength and timing of the input.</li>
</ul>
<p>This evoked drive causes the initial positive deflection in the
dipole signal, triggering a cascade of activity through the network and
resulting in the complex waveforms observed.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        def set_params(param_values, net=None):
    """
    Set parameters for the network drives.

    Parameters
    ----------
    param_values : dict
        Dictionary of parameter values.
    net : instance of Network, optional
        If None, a new network is created using the specified model type.
    """
    weights_ampa = {'L2_basket': param_values['weight_basket'],
                    'L2_pyramidal': param_values['weight_pyr'],
                    'L5_basket': param_values['weight_basket'],
                    'L5_pyramidal': param_values['weight_pyr']}

    synaptic_delays = {'L2_basket': 0.1, 'L2_pyramidal': 0.1,
                       'L5_basket': 1., 'L5_pyramidal': 1.}

    # Add an evoked drive to the network.
    net.add_evoked_drive('evprox',
                         mu=40,
                         sigma=5,
                         numspikes=1,
                         location='proximal',
                         weights_ampa=weights_ampa,
                         synaptic_delays=synaptic_delays)
    </code>
</div>
<div class='markdown-cell'>
    <p>Next, we define a parameter grid for the batch simulation.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        param_grid = {
    'weight_basket': np.logspace(-4, -1, 20),
    'weight_pyr': np.logspace(-4, -1, 20)
}
    </code>
</div>
<div class='markdown-cell'>
    <p>We then define a function to calculate summary statistics.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        def summary_func(results):
    """
    Calculate the min and max dipole peak for each simulation result.

    Parameters
    ----------
    results : list
        List of dictionaries containing simulation results.

    Returns
    -------
    summary_stats : list
        Summary statistics for each simulation result.
    """
    summary_stats = []
    for result in results:
        dpl_smooth = result['dpl'][0].copy().smooth(window_len=30)
        dpl_data = dpl_smooth.data['agg']
        min_peak = np.min(dpl_data)
        max_peak = np.max(dpl_data)
        summary_stats.append({'min_peak': min_peak, 'max_peak': max_peak})
    return summary_stats
    </code>
</div>
<div class='markdown-cell'>
    <p>Run the batch simulation and collect the results.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        # Initialize the network model and run the batch simulation.
net = jones_2009_model(mesh_shape=(3, 3))
batch_simulation = BatchSimulate(net=net,
                                 set_params=set_params,
                                 summary_func=summary_func)
simulation_results = batch_simulation.run(param_grid,
                                          n_jobs=n_jobs,
                                          combinations=False,
                                          backend='loky')

print("Simulation results:", simulation_results)
    </code>
</div>
<div class='output-cell'><div class='output-label'>
    Out:
</div>
    <div class='output-code'>
        [Parallel(n_jobs=4)]: Using backend LokyBackend with 4 concurrent workers.

        Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Loading custom mechanism files from /Users/austinsoplata/rep/brn/hnn-core/hnn_core/mod/arm64/.libs/libnrnmech.so
Building the NEURON model
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Loading custom mechanism files from /Users/austinsoplata/rep/brn/hnn-core/hnn_core/mod/arm64/.libs/libnrnmech.so
Building the NEURON model
[Done]
Trial 1: 0.03 ms...
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
[Done]
Loading custom mechanism files from /Users/austinsoplata/rep/brn/hnn-core/hnn_core/mod/arm64/.libs/libnrnmech.so
Building the NEURON model
Trial 1: 0.03 ms...
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Loading custom mechanism files from /Users/austinsoplata/rep/brn/hnn-core/hnn_core/mod/arm64/.libs/libnrnmech.so
Building the NEURON model
Trial 1: 10.0 ms...
[Done]
Trial 1: 0.03 ms...
Trial 1: 10.0 ms...
[Done]
Trial 1: 0.03 ms...
Trial 1: 20.0 ms...
Trial 1: 10.0 ms...
Trial 1: 20.0 ms...
Trial 1: 10.0 ms...
Trial 1: 30.0 ms...
Trial 1: 20.0 ms...
Trial 1: 30.0 ms...
Trial 1: 20.0 ms...
Trial 1: 40.0 ms...
Trial 1: 30.0 ms...
Trial 1: 40.0 ms...
Trial 1: 30.0 ms...
Trial 1: 50.0 ms...
Trial 1: 40.0 ms...
Trial 1: 50.0 ms...
Trial 1: 40.0 ms...
Trial 1: 60.0 ms...
Trial 1: 50.0 ms...
Trial 1: 60.0 ms...
Trial 1: 50.0 ms...
Trial 1: 70.0 ms...
Trial 1: 60.0 ms...
Trial 1: 70.0 ms...
Trial 1: 60.0 ms...
Trial 1: 80.0 ms...
Trial 1: 70.0 ms...
Trial 1: 80.0 ms...
Trial 1: 70.0 ms...
Trial 1: 90.0 ms...
Trial 1: 80.0 ms...
Trial 1: 90.0 ms...
Trial 1: 80.0 ms...
Trial 1: 100.0 ms...
Trial 1: 90.0 ms...
Trial 1: 100.0 ms...
Trial 1: 90.0 ms...
Trial 1: 110.0 ms...
Trial 1: 100.0 ms...
Trial 1: 110.0 ms...
Trial 1: 100.0 ms...
Trial 1: 120.0 ms...
Trial 1: 110.0 ms...
Trial 1: 120.0 ms...
Trial 1: 110.0 ms...
Trial 1: 130.0 ms...
Trial 1: 120.0 ms...
Trial 1: 130.0 ms...
Trial 1: 120.0 ms...
Trial 1: 140.0 ms...
Trial 1: 130.0 ms...
Trial 1: 140.0 ms...
Trial 1: 130.0 ms...
Trial 1: 150.0 ms...
Trial 1: 140.0 ms...
Trial 1: 150.0 ms...
Trial 1: 140.0 ms...
Trial 1: 160.0 ms...
Trial 1: 150.0 ms...
Trial 1: 160.0 ms...
Trial 1: 150.0 ms...
[Parallel(n_jobs=4)]: Done   1 tasks      | elapsed:    2.6s
Trial 1: 160.0 ms...
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
Trial 1: 160.0 ms...
[Parallel(n_jobs=4)]: Done   2 tasks      | elapsed:    2.6s
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
[Done]
Trial 1: 0.03 ms...
[Parallel(n_jobs=4)]: Done   3 tasks      | elapsed:    2.6s
[Parallel(n_jobs=4)]: Done   4 tasks      | elapsed:    2.6s
[Done]
Trial 1: 0.03 ms...
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
Trial 1: 10.0 ms...
[Done]
Trial 1: 0.03 ms...
Trial 1: 10.0 ms...
[Done]
Trial 1: 0.03 ms...
Trial 1: 20.0 ms...
Trial 1: 10.0 ms...
Trial 1: 20.0 ms...
Trial 1: 10.0 ms...
Trial 1: 30.0 ms...
Trial 1: 20.0 ms...
Trial 1: 30.0 ms...
Trial 1: 20.0 ms...
Trial 1: 40.0 ms...
Trial 1: 30.0 ms...
Trial 1: 40.0 ms...
Trial 1: 30.0 ms...
Trial 1: 50.0 ms...
Trial 1: 40.0 ms...
Trial 1: 50.0 ms...
Trial 1: 40.0 ms...
Trial 1: 60.0 ms...
Trial 1: 50.0 ms...
Trial 1: 60.0 ms...
Trial 1: 50.0 ms...
Trial 1: 70.0 ms...
Trial 1: 60.0 ms...
Trial 1: 70.0 ms...
Trial 1: 60.0 ms...
Trial 1: 80.0 ms...
Trial 1: 70.0 ms...
Trial 1: 80.0 ms...
Trial 1: 70.0 ms...
Trial 1: 90.0 ms...
Trial 1: 80.0 ms...
Trial 1: 90.0 ms...
Trial 1: 80.0 ms...
Trial 1: 100.0 ms...
Trial 1: 90.0 ms...
Trial 1: 100.0 ms...
Trial 1: 90.0 ms...
Trial 1: 110.0 ms...
Trial 1: 100.0 ms...
Trial 1: 110.0 ms...
Trial 1: 100.0 ms...
Trial 1: 120.0 ms...
Trial 1: 110.0 ms...
Trial 1: 120.0 ms...
Trial 1: 110.0 ms...
Trial 1: 130.0 ms...
Trial 1: 120.0 ms...
Trial 1: 130.0 ms...
Trial 1: 120.0 ms...
Trial 1: 140.0 ms...
Trial 1: 130.0 ms...
Trial 1: 140.0 ms...
Trial 1: 130.0 ms...
Trial 1: 150.0 ms...
Trial 1: 140.0 ms...
Trial 1: 150.0 ms...
Trial 1: 140.0 ms...
Trial 1: 160.0 ms...
Trial 1: 150.0 ms...
Trial 1: 160.0 ms...
Trial 1: 150.0 ms...
[Parallel(n_jobs=4)]: Done   5 tasks      | elapsed:    3.3s
Trial 1: 160.0 ms...
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
[Parallel(n_jobs=4)]: Done   6 tasks      | elapsed:    3.3s
Trial 1: 160.0 ms...
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
[Done]
Trial 1: 0.03 ms...
[Parallel(n_jobs=4)]: Done   7 tasks      | elapsed:    3.3s
[Done]
Trial 1: 0.03 ms...
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
[Parallel(n_jobs=4)]: Done   8 tasks      | elapsed:    3.3s
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
Trial 1: 10.0 ms...
[Done]
Trial 1: 0.03 ms...
Trial 1: 10.0 ms...
[Done]
Trial 1: 0.03 ms...
Trial 1: 20.0 ms...
Trial 1: 10.0 ms...
Trial 1: 20.0 ms...
Trial 1: 10.0 ms...
Trial 1: 30.0 ms...
Trial 1: 20.0 ms...
Trial 1: 30.0 ms...
Trial 1: 20.0 ms...
Trial 1: 40.0 ms...
Trial 1: 30.0 ms...
Trial 1: 40.0 ms...
Trial 1: 30.0 ms...
Trial 1: 50.0 ms...
Trial 1: 40.0 ms...
Trial 1: 50.0 ms...
Trial 1: 40.0 ms...
Trial 1: 60.0 ms...
Trial 1: 50.0 ms...
Trial 1: 60.0 ms...
Trial 1: 50.0 ms...
Trial 1: 70.0 ms...
Trial 1: 60.0 ms...
Trial 1: 70.0 ms...
Trial 1: 60.0 ms...
Trial 1: 80.0 ms...
Trial 1: 70.0 ms...
Trial 1: 80.0 ms...
Trial 1: 70.0 ms...
Trial 1: 90.0 ms...
Trial 1: 80.0 ms...
Trial 1: 90.0 ms...
Trial 1: 80.0 ms...
Trial 1: 100.0 ms...
Trial 1: 90.0 ms...
Trial 1: 100.0 ms...
Trial 1: 90.0 ms...
Trial 1: 110.0 ms...
Trial 1: 100.0 ms...
Trial 1: 110.0 ms...
Trial 1: 100.0 ms...
Trial 1: 120.0 ms...
Trial 1: 110.0 ms...
Trial 1: 120.0 ms...
Trial 1: 110.0 ms...
Trial 1: 130.0 ms...
Trial 1: 120.0 ms...
Trial 1: 130.0 ms...
Trial 1: 120.0 ms...
Trial 1: 140.0 ms...
Trial 1: 130.0 ms...
Trial 1: 140.0 ms...
Trial 1: 130.0 ms...
Trial 1: 150.0 ms...
Trial 1: 140.0 ms...
Trial 1: 150.0 ms...
Trial 1: 140.0 ms...
Trial 1: 160.0 ms...
Trial 1: 150.0 ms...
Trial 1: 160.0 ms...
Trial 1: 150.0 ms...
[Parallel(n_jobs=4)]: Done   9 tasks      | elapsed:    4.0s
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
Trial 1: 160.0 ms...
[Parallel(n_jobs=4)]: Done  10 tasks      | elapsed:    4.0s
Trial 1: 160.0 ms...
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
[Done]
Trial 1: 0.03 ms...
[Done]
[Parallel(n_jobs=4)]: Done  11 tasks      | elapsed:    4.0s
Trial 1: 0.03 ms...
[Parallel(n_jobs=4)]: Done  12 tasks      | elapsed:    4.0s
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
Trial 1: 10.0 ms...
[Done]
Trial 1: 0.03 ms...
Trial 1: 10.0 ms...
[Done]
Trial 1: 0.03 ms...
Trial 1: 20.0 ms...
Trial 1: 10.0 ms...
Trial 1: 20.0 ms...
Trial 1: 10.0 ms...
Trial 1: 30.0 ms...
Trial 1: 20.0 ms...
Trial 1: 30.0 ms...
Trial 1: 20.0 ms...
Trial 1: 40.0 ms...
Trial 1: 30.0 ms...
Trial 1: 40.0 ms...
Trial 1: 30.0 ms...
Trial 1: 50.0 ms...
Trial 1: 40.0 ms...
Trial 1: 50.0 ms...
Trial 1: 40.0 ms...
Trial 1: 60.0 ms...
Trial 1: 50.0 ms...
Trial 1: 60.0 ms...
Trial 1: 50.0 ms...
Trial 1: 70.0 ms...
Trial 1: 60.0 ms...
Trial 1: 70.0 ms...
Trial 1: 60.0 ms...
Trial 1: 80.0 ms...
Trial 1: 70.0 ms...
Trial 1: 80.0 ms...
Trial 1: 70.0 ms...
Trial 1: 90.0 ms...
Trial 1: 80.0 ms...
Trial 1: 90.0 ms...
Trial 1: 80.0 ms...
Trial 1: 100.0 ms...
Trial 1: 90.0 ms...
Trial 1: 100.0 ms...
Trial 1: 90.0 ms...
Trial 1: 110.0 ms...
Trial 1: 100.0 ms...
Trial 1: 110.0 ms...
Trial 1: 100.0 ms...
Trial 1: 120.0 ms...
Trial 1: 110.0 ms...
Trial 1: 120.0 ms...
Trial 1: 110.0 ms...
Trial 1: 130.0 ms...
Trial 1: 120.0 ms...
Trial 1: 130.0 ms...
Trial 1: 120.0 ms...
Trial 1: 140.0 ms...
Trial 1: 130.0 ms...
Trial 1: 140.0 ms...
Trial 1: 130.0 ms...
Trial 1: 150.0 ms...
Trial 1: 140.0 ms...
Trial 1: 150.0 ms...
Trial 1: 140.0 ms...
Trial 1: 160.0 ms...
Trial 1: 150.0 ms...
Trial 1: 160.0 ms...
Trial 1: 150.0 ms...
[Parallel(n_jobs=4)]: Done  13 tasks      | elapsed:    4.7s
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
Trial 1: 160.0 ms...
[Parallel(n_jobs=4)]: Done  14 out of  20 | elapsed:    4.7s remaining:    2.0s
Trial 1: 160.0 ms...
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
[Done]
Trial 1: 0.03 ms...
[Done]
[Parallel(n_jobs=4)]: Done  15 out of  20 | elapsed:    4.7s remaining:    1.6s
Trial 1: 0.03 ms...
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
[Parallel(n_jobs=4)]: Done  16 out of  20 | elapsed:    4.7s remaining:    1.2s
Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Building the NEURON model
Trial 1: 10.0 ms...
[Done]
Trial 1: 0.03 ms...
Trial 1: 10.0 ms...
[Done]
Trial 1: 0.03 ms...
Trial 1: 20.0 ms...
Trial 1: 10.0 ms...
Trial 1: 20.0 ms...
Trial 1: 10.0 ms...
Trial 1: 30.0 ms...
Trial 1: 20.0 ms...
Trial 1: 30.0 ms...
Trial 1: 20.0 ms...
Trial 1: 40.0 ms...
Trial 1: 30.0 ms...
Trial 1: 40.0 ms...
Trial 1: 30.0 ms...
Trial 1: 50.0 ms...
Trial 1: 40.0 ms...
Trial 1: 50.0 ms...
Trial 1: 40.0 ms...
Trial 1: 60.0 ms...
Trial 1: 50.0 ms...
Trial 1: 60.0 ms...
Trial 1: 50.0 ms...
Trial 1: 70.0 ms...
Trial 1: 60.0 ms...
Trial 1: 70.0 ms...
Trial 1: 60.0 ms...
Trial 1: 80.0 ms...
Trial 1: 70.0 ms...
Trial 1: 80.0 ms...
Trial 1: 70.0 ms...
Trial 1: 90.0 ms...
Trial 1: 80.0 ms...
Trial 1: 90.0 ms...
Trial 1: 80.0 ms...
Trial 1: 100.0 ms...
Trial 1: 90.0 ms...
Trial 1: 100.0 ms...
Trial 1: 90.0 ms...
Trial 1: 110.0 ms...
Trial 1: 100.0 ms...
Trial 1: 110.0 ms...
Trial 1: 100.0 ms...
Trial 1: 120.0 ms...
Trial 1: 110.0 ms...
Trial 1: 120.0 ms...
Trial 1: 110.0 ms...
Trial 1: 130.0 ms...
Trial 1: 120.0 ms...
Trial 1: 130.0 ms...
Trial 1: 120.0 ms...
Trial 1: 140.0 ms...
Trial 1: 130.0 ms...
Trial 1: 140.0 ms...
Trial 1: 130.0 ms...
Trial 1: 150.0 ms...
Trial 1: 140.0 ms...
Trial 1: 150.0 ms...
Trial 1: 140.0 ms...
Trial 1: 160.0 ms...
Trial 1: 150.0 ms...
Trial 1: 150.0 ms...
Trial 1: 160.0 ms...
[Parallel(n_jobs=4)]: Done  17 out of  20 | elapsed:    5.4s remaining:    0.9s
Trial 1: 160.0 ms...
Trial 1: 160.0 ms...
[Parallel(n_jobs=4)]: Done  18 out of  20 | elapsed:    5.4s remaining:    0.6s
[Parallel(n_jobs=4)]: Done  20 out of  20 | elapsed:    5.4s finished
Simulation results: {&#x27;summary_statistics&#x27;: [[{&#x27;min_peak&#x27;: -1.9487233699163027e-05, &#x27;max_peak&#x27;: 2.438299811172476e-05}, {&#x27;min_peak&#x27;: -1.9487233699163027e-05, &#x27;max_peak&#x27;: 3.5625970074068226e-05}, {&#x27;min_peak&#x27;: -1.9487233699163027e-05, &#x27;max_peak&#x27;: 5.187123572695806e-05}, {&#x27;min_peak&#x27;: -1.9487233699163027e-05, &#x27;max_peak&#x27;: 7.53973769021332e-05}, {&#x27;min_peak&#x27;: -1.9487233699163027e-05, &#x27;max_peak&#x27;: 0.00010962271639761108}, {&#x27;min_peak&#x27;: -0.000818709814074504, &#x27;max_peak&#x27;: 0.0011853731897260855}, {&#x27;min_peak&#x27;: -0.0006900911098816319, &#x27;max_peak&#x27;: 0.001453236614203411}, {&#x27;min_peak&#x27;: -7.443630674152589e-05, &#x27;max_peak&#x27;: 0.0006303483688791772}, {&#x27;min_peak&#x27;: -0.0003831247250500106, &#x27;max_peak&#x27;: 0.0015588783545865915}, {&#x27;min_peak&#x27;: -0.0005827286517535978, &#x27;max_peak&#x27;: 0.0014794795458269567}, {&#x27;min_peak&#x27;: -0.0005759203533290788, &#x27;max_peak&#x27;: 0.0014539235295249035}, {&#x27;min_peak&#x27;: -1.9487233699163027e-05, &#x27;max_peak&#x27;: 0.0013262182394243836}, {&#x27;min_peak&#x27;: -1.9487233699163027e-05, &#x27;max_peak&#x27;: 0.001328331309960044}, {&#x27;min_peak&#x27;: -1.9487233699163027e-05, &#x27;max_peak&#x27;: 0.0011853462053579697}, {&#x27;min_peak&#x27;: -1.9487233699163027e-05, &#x27;max_peak&#x27;: 0.001164963332945789}, {&#x27;min_peak&#x27;: -1.9487233699163027e-05, &#x27;max_peak&#x27;: 0.001184585414815396}, {&#x27;min_peak&#x27;: -1.9487233699163027e-05, &#x27;max_peak&#x27;: 0.001231155285096099}, {&#x27;min_peak&#x27;: -1.9487233699163027e-05, &#x27;max_peak&#x27;: 0.0013115554222262646}, {&#x27;min_peak&#x27;: -1.9487233699163027e-05, &#x27;max_peak&#x27;: 0.0014314315232221647}, {&#x27;min_peak&#x27;: -1.9487233699163027e-05, &#x27;max_peak&#x27;: 0.001512378997571946}]], &#x27;simulated_data&#x27;: [[{&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.0001, &#x27;weight_pyr&#x27;: 0.0001}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x127de9250&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.0001438449888287663, &#x27;weight_pyr&#x27;: 0.0001438449888287663}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x127df2210&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.00020691380811147902, &#x27;weight_pyr&#x27;: 0.00020691380811147902}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x127df4530&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.00029763514416313193, &#x27;weight_pyr&#x27;: 0.00029763514416313193}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x127df32c0&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.00042813323987193956, &#x27;weight_pyr&#x27;: 0.00042813323987193956}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x127df55b0&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.0006158482110660267, &#x27;weight_pyr&#x27;: 0.0006158482110660267}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x127df6d20&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.0008858667904100823, &#x27;weight_pyr&#x27;: 0.0008858667904100823}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x127df0200&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.0012742749857031334, &#x27;weight_pyr&#x27;: 0.0012742749857031334}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x127de8e30&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.0018329807108324356, &#x27;weight_pyr&#x27;: 0.0018329807108324356}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x127df9fa0&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.0026366508987303583, &#x27;weight_pyr&#x27;: 0.0026366508987303583}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x12e9334d0&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.00379269019073225, &#x27;weight_pyr&#x27;: 0.00379269019073225}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x127dec8f0&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.005455594781168515, &#x27;weight_pyr&#x27;: 0.005455594781168515}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x127df5a30&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.007847599703514606, &#x27;weight_pyr&#x27;: 0.007847599703514606}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x12e8a64b0&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.011288378916846883, &#x27;weight_pyr&#x27;: 0.011288378916846883}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x127def7a0&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.01623776739188721, &#x27;weight_pyr&#x27;: 0.01623776739188721}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x12e930680&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.023357214690901212, &#x27;weight_pyr&#x27;: 0.023357214690901212}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x12e931730&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.03359818286283781, &#x27;weight_pyr&#x27;: 0.03359818286283781}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x12ea9a360&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.04832930238571752, &#x27;weight_pyr&#x27;: 0.04832930238571752}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x12ea9b440&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.06951927961775606, &#x27;weight_pyr&#x27;: 0.06951927961775606}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x127df84d0&gt;]}, {&#x27;net&#x27;: &lt;Network | 3 x 3 Pyramidal cells (L2, L5)
3 L2 basket cells
3 L5 basket cells&gt;, &#x27;param_values&#x27;: {&#x27;weight_basket&#x27;: 0.1, &#x27;weight_pyr&#x27;: 0.1}, &#x27;dpl&#x27;: [&lt;hnn_core.dipole.Dipole object at 0x127de9640&gt;]}]]}

    </div>
</div>
<div class='markdown-cell'>
    <p>This plot shows an overlay of all smoothed dipole waveforms from the
batch simulation. Each line represents a different set of synaptic
strength parameters (<code>weight_basket</code>), allowing us to
visualize the range of responses across the parameter space. The
colormap represents synaptic strengths, from weaker (purple) to stronger
(yellow).</p>
<p>As drive strength increases, dipole responses show progressively
larger amplitudes and more distinct features, reflecting heightened
network activity. Weak drives (purple lines) produce smaller amplitude
signals with simpler waveforms, while stronger drives (yellow lines)
generate larger responses with more pronounced oscillatory features,
indicating more robust network activity.</p>
<p>The y-axis represents dipole amplitude in <code>nAm</code>
(nanoAmpere-meters), which is the product of current flow and distance
in the neural tissue.</p>
<p>Stronger synaptic connections (yellow lines) generally show larger
amplitude responses and more pronounced features throughout the
simulation.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        dpl_waveforms, param_values = [], []
for data_list in simulation_results['simulated_data']:
    for data in data_list:
        dpl_smooth = data['dpl'][0].copy().smooth(window_len=30)
        dpl_waveforms.append(dpl_smooth.data['agg'])
        param_values.append(data['param_values']['weight_basket'])

plt.figure(figsize=(10, 6))
cmap = plt.get_cmap('viridis')
log_param_values = np.log10(param_values)
norm = plt.Normalize(log_param_values.min(), log_param_values.max())

for waveform, log_param in zip(dpl_waveforms, log_param_values):
    color = cmap(norm(log_param))
    plt.plot(waveform, color=color, alpha=0.7, linewidth=2)
plt.title('Overlay of Dipole Waveforms')
plt.xlabel('Time (ms)')
plt.ylabel('Dipole Amplitude (nAm)')
plt.grid(True)
plt.tight_layout()
plt.show()
    </code>
</div>
<div class='output-cell'><div class='output-label'>
    Out:
</div>
    <div class='output-code'>
        &lt;Figure size 1000x600 with 1 Axes&gt;
    </div>
</div>
<div class='output-cell'>
    <img src='output_nb_batch_simulation_notebook/fig_01.png'/>
</div>
<div class='markdown-cell'>
    <p>This plot displays the minimum and maximum dipole peaks across
different synaptic strengths. This allows us to see how the range of
dipole activity changes as we vary the synaptic strength parameter.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        min_peaks, max_peaks, param_values = [], [], []
for summary_list, data_list in zip(simulation_results['summary_statistics'],
                                   simulation_results['simulated_data']):
    for summary, data in zip(summary_list, data_list):
        min_peaks.append(summary['min_peak'])
        max_peaks.append(summary['max_peak'])
        param_values.append(data['param_values']['weight_basket'])

# Plotting
plt.figure(figsize=(10, 6))
plt.plot(param_values, min_peaks, label='Min Dipole Peak')
plt.plot(param_values, max_peaks, label='Max Dipole Peak')
plt.xlabel('Synaptic Strength (nS)')
plt.ylabel('Dipole Peak Magnitude')
plt.title('Min and Max Dipole Peaks across Simulations')
plt.legend()
plt.grid(True)
plt.xscale('log')
plt.tight_layout()
plt.show()
    </code>
</div>
<div class='output-cell'><div class='output-label'>
    Out:
</div>
    <div class='output-code'>
        &lt;Figure size 1000x600 with 1 Axes&gt;
    </div>
</div>
<div class='output-cell'>
    <img src='output_nb_batch_simulation_notebook/fig_02.png'/>
</div>
        <!-- footer area -->
        <!----------------->
        <div class="footer-area">
            <div class="previous-area" data-link="/textbook/content/08_using_hnn_api/animating_hnn_simulations.html">
                <div class="previous-icon">
                    <svg class="svg-arrow" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path class="arrow-path" d="M15 5L9 12L15 19" />
                    </svg>
                </div>
                <div class="previous-text">
                    <p>Previous</p>
                    <a>7.4 Animating HNN Simulations</a>
                </div>
            </div>
            <div class="next-area" data-link="/textbook/content/08_using_hnn_api/simulate_beta_modulated_erp.html">
                <div class="next-text">
                    <p>Next</p>
                    <a>7.6 Simulate Beta-modulated ERP</a>
                </div>
                <div class="next-icon">
                    <svg class="svg-arrow" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path class="arrow-path" d="M15 5L9 12L15 19" />
                    </svg>
                </div>
            </div>
        </div> <!-- close footer -->
    </div> <!-- close content -->
    </div> <!-- close content wrapper -->
</div> <!-- close main -->
<script>
    // ----------------------------------------
    // Manage footer
    // ----------------------------------------
    // This function will update the footer links when a page is loaded
    // locally so that naivagation remains functional without a server
    // Note: this solution is specific to MacOS
    document.addEventListener("DOMContentLoaded", function() {
        if (window.location.protocol === "file:") {
            // Get the current local directory path
            const currentDir = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));

            // Process both previous and next links
            document.querySelectorAll('.previous-area, .next-area').forEach(function(area) {
                const link = area.getAttribute('data-link');
                
                if (link && link.startsWith("/")) {
                    // Extract the local root directory
                    const rootPath = currentDir.split("/textbook/")[0];
                    // Prepend root path to link
                    const resolvedLink = "file://" + rootPath + link;
                    area.setAttribute("data-link", resolvedLink);
                }
            });
        }
    });
    // Hide the area if data-link is 'None'
    document.querySelectorAll('.previous-area, .next-area').forEach(function(area) {
        if (area.getAttribute('data-link') === 'None') {
            area.style.display = 'none'; 
        }
    });

    // Redirect to the specified link
    document.querySelectorAll('.previous-area, .next-area').forEach(function(area) {
        area.addEventListener('click', function() {
            window.location.href = area.getAttribute('data-link');
        });
    });

    // ----------------------------------------
    // Manage sidebar
    // ----------------------------------------
    let isSidebarOpen = true; // Sidebar is initially open
    let isSidebarFullyOpen = true; // Sidebar is fully open
    const maxWidth = '350px';

    function toggleNav() {
        const sidebar = document.getElementById("mySidebar");
        const main = document.getElementById("main");
        const topbar = document.querySelector(".topbar");

        // Toggle sidebar state
        if (isSidebarOpen) {
            sidebar.style.width = "0";
            main.style.marginLeft = "0";
            topbar.style.marginLeft = "0";
            topbar.style.width = "100%";
            isSidebarFullyOpen = false;
        } else {
            sidebar.style.width = maxWidth;
            main.style.marginLeft = maxWidth;
                // match margin to new width
            topbar.style.marginLeft = maxWidth;
            topbar.style.width = `calc(100% - ${maxWidth})`;
                // adjust topbar width
        }

        // Toggle the sidebar state
        isSidebarOpen = !isSidebarOpen;

        // Store the sidebar state in localStorage
        localStorage.setItem("sidebarState", isSidebarOpen ? "open" : "closed");
    }

    // Always listen for the transitionend on the sidebar
    const sidebar = document.getElementById("mySidebar");
    sidebar.addEventListener('transitionend', function() {
        if (sidebar.style.width === maxWidth) {
            // Sidebar has fully opened
            isSidebarFullyOpen = true;
        } else {
            // Sidebar is not fully open
            isSidebarFullyOpen = false;
        }
    });

    // Open the sidebar on page load
    // -----------------------------

    // Apply sidebar state before the page renders
    // Added to help with initial page "flicker" as the position is
    // calculated and applied
    const savedState = localStorage.getItem("sidebarState");
    if (savedState === "closed") {
        document.body.classList.add("sidebar-closed");
    } else {
        document.body.classList.add("sidebar-open");
    }

    window.onload = function() {
        const sidebar = document.getElementById("mySidebar");
        const main = document.getElementById("main");
        const topbar = document.querySelector(".topbar");

        // Retrieve stored state
        const savedState = localStorage.getItem("sidebarState");

        // Determine initial state
        if (savedState === "closed") {
            sidebar.style.width = "0";
            main.style.marginLeft = "0";
            topbar.style.marginLeft = "0";
            topbar.style.width = "100%";
            isSidebarOpen = false;
            isSidebarFullyOpen = false;
        } else {
            sidebar.style.width = maxWidth;
            main.style.marginLeft = maxWidth;
            topbar.style.marginLeft = maxWidth;
            topbar.style.width = `calc(100% - ${maxWidth})`;
            isSidebarOpen = true;
            isSidebarFullyOpen = true;
        }

        // Disable transition for the initial state
        sidebar.style.transition = "none";
        main.style.transition = "none";
        topbar.style.transition = "none";

        // Re-enable transition for subsequent toggles
        setTimeout(() => {
            sidebar.style.transition = "width 0.5s";
            main.style.transition = "margin-left 0.5s";
            topbar.style.transition = "margin-left 0.5s, width 0.5s";
        }, 10);
    }

    function toggleSubmenu(event) {
        const header = event.target.closest('#sidebar-header');
            // Get the clicked header
        const submenu = header.nextElementSibling;
            // Get the submenu
        const toggleIcon = header.querySelector('.toggle-icon');
            // Get the icon

        if (submenu && submenu.classList.contains('submenu')) {
            submenu.classList.toggle('open'); 
                // Toggle the 'open' class to control visibility
            toggleIcon.textContent = submenu.classList.contains('open') ? '-' : '+'; 
                // Update icon
        }
    }

    // Resolve sidebar links for local development
    // -------------------------------------------
    // This function will update the sidebar links when a page is loaded
    // locally so that sidebar naivagation remains functional without a server
    // Note: this solution is specific to MacOS
    document.addEventListener("DOMContentLoaded", function() {
        if (window.location.protocol === "file:") {
            // get the current local directory path
            const currentDir = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));

            // get 'absolute' links with root of 'textbook'
            const links = document.querySelectorAll("#mySidebar a");
            links.forEach(link => {
                const href = link.getAttribute("href");

                if (href && href.startsWith("/")) {
                    // extract the local root directory
                    const rootPath = currentDir.split("/textbook/")[0];
                    // prepend root path to link
                    const resolvedHref = "file://" + rootPath + href;
                    link.setAttribute("href", resolvedHref);
                }
            });

            // Update image sources for icons
            const images = document.querySelectorAll(".social-icons img, .menu-icons img");
            images.forEach(img => {
                const src = img.getAttribute("src");

                if (src && src.startsWith("/")) {
                    // extract the local root directory
                    const rootPath = currentDir.split("/textbook/")[0];
                    // prepend root path to image source
                    const resolvedSrc = "file://" + rootPath + src;
                    img.setAttribute("src", resolvedSrc);
                }
            });
        }
    });

    // Custom tooltips for the sidebar
    // -------------------------------
    // Flag to track tooltip visibility
    let isTooltipVisible = false;

    // Add text to the 'sidebar-tooltip' attribute for sidebar anchor tags
    document.querySelectorAll('.sidebar a').forEach(anchor => {
        const cleanedText = anchor.textContent.replace(/[+\-]/g, '').trim();
        anchor.setAttribute('sidebar-tooltip', cleanedText);
    });

    // Handle sidebar tooltips
    document.querySelectorAll('.sidebar a').forEach(function(link) {
        link.addEventListener('mouseenter', function(event) {
            const tooltipText = event.target.getAttribute('sidebar-tooltip');
            
            if (!tooltipText || isTooltipVisible || !isSidebarFullyOpen) return; // Only show tooltip if none is visible

            // Check if the text is overflowing
            if (event.target.scrollWidth > event.target.offsetWidth) {
                const delay = 500; // Set the delay time (in ms), adjust as needed

                // Create the tooltip after the delay
                setTimeout(function() {
                    // Remove any existing tooltips
                    const existingTooltip = document.querySelector('.sidebar-tooltip');
                    if (existingTooltip) {
                        existingTooltip.remove();
                    }

                    // Create the tooltip element dynamically
                    const tooltip = document.createElement('div');
                    tooltip.classList.add('sidebar-tooltip');  // Use the existing class
                    tooltip.innerText = tooltipText;

                    // Append the tooltip to the sidebar container
                    const sidebarContainer = document.querySelector('.sidebar');
                    sidebarContainer.appendChild(tooltip);

                    // Get the position of the link and the sidebar container
                    const rect = event.target.getBoundingClientRect();
                    const sidebarRect = sidebarContainer.getBoundingClientRect();

                    // Position the tooltip relative to the sidebar container
                    tooltip.style.position = 'absolute';
                    tooltip.style.left = `${rect.left - sidebarRect.left + sidebarContainer.scrollLeft + 20}px`;
                    tooltip.style.top = `${rect.bottom - sidebarRect.top + sidebarContainer.scrollTop + 5}px`;

                    // Make sure the tooltip is visible
                    tooltip.style.opacity = '1';

                    // Set the flag to true indicating that the tooltip is visible
                    isTooltipVisible = true;
                }, delay); // Delay the tooltip creation
            }
        });

        link.addEventListener('mouseleave', function(event) {
            // Remove the tooltip when the mouse leaves
            const tooltip = document.querySelector('.sidebar-tooltip');
            if (tooltip) {
                tooltip.remove();
            }

            // Reset the flag to false when the tooltip is removed
            isTooltipVisible = false;
        });
    });

    // Close all open submenus in the sidebar
    // --------------------------------------
    document.addEventListener("DOMContentLoaded", function() {
        // Function to close all open submenus in the navbar
        function closeAllSubmenus() {
            const allSubmenus = document.querySelectorAll('.submenu.open'); // Select all open submenus
            allSubmenus.forEach(submenu => {
                submenu.classList.remove('open'); // Remove 'open' class to collapse
                const toggleIcon = submenu.previousElementSibling.querySelector('.toggle-icon');
                if (toggleIcon) {
                    toggleIcon.textContent = '+'; // Reset icon to '+'
                }
            });
        }

        // Add functionality to collapse button (SVG icon)
        const collapseIcon = document.querySelector('.collapse-icon');
        if (collapseIcon) {
            collapseIcon.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent event propagation to avoid unwanted behavior
                closeAllSubmenus(); // Close all open submenus when the icon is clicked
            });
        }
    });

    // Keep the current page open in the sidebar
    // -----------------------------------------
    document.addEventListener("DOMContentLoaded", function () {
        // Get the full path relative to the 'content' folder
        const currentPage = window.location.pathname.split("/content/")[1].split("?")[0];

        // Find the active link using the full path
        const activeLink = document.querySelector(`#mySidebar a[href$='${currentPage}']`);

        if (activeLink) {
            // Apply the active class
            activeLink.classList.add("active");
             // Find the closest submenu
            const submenu = activeLink.closest('.submenu');

            if (submenu) {
                // Keep the submenu open
                submenu.classList.add('open');
                const toggleIcon = submenu.previousElementSibling.querySelector('.toggle-icon');

                if (toggleIcon) {
                    // Ensure the toggle icon reflects the open state
                    toggleIcon.textContent = '-';
                }
            }
        }
    });

    // ------------------------------
    // Font size buttons and dropdown
    // ------------------------------
    document.addEventListener("DOMContentLoaded", function() {
        const content = document.getElementById("content");

        // Retrieve and apply the saved font size
        const savedFontSize = localStorage.getItem("fontSize");
        if (savedFontSize && content) {
            content.style.fontSize = savedFontSize + "px";
        }
    });

    function increaseFontSize() {
        event.stopPropagation();  // Prevent dropdown from closing
        const content = document.getElementById("content");
        const currentSize = parseFloat(window.getComputedStyle(content).fontSize);
        const newSize = currentSize + 1;

        content.style.fontSize = newSize + "px";

        // save font size to localStorage
        localStorage.setItem("fontSize", newSize);
    }

    function decreaseFontSize() {
        event.stopPropagation();  // Prevent dropdown from closing
        const content = document.getElementById("content");
        const currentSize = parseFloat(window.getComputedStyle(content).fontSize);
        const newSize = currentSize - 1;

        content.style.fontSize = newSize + "px";

        // save font size to localStorage
        localStorage.setItem("fontSize", newSize);
    }

    // Dropdown for font buttons
    function toggleDropdown() {
        const dropdownContent = document.querySelector('.dropdown-content');
        dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
    }

    // Open/close dropdown on click of the button
    document.getElementById('dropdownButton').onclick = function(event) {
        event.stopPropagation();  // Prevent the click from triggering the window.onclick event
        toggleDropdown();
    };

    // Close dropdown if clicking outside
    window.onclick = function(event) {
        const dropdownContent = document.querySelector('.dropdown-content');
        if (!event.target.closest('.dropdown')) {  // Close if click outside the dropdown
            dropdownContent.style.display = 'none';
        }
    };

    // ----------------------------------------
    // Toggle between light and dark themes
    // ----------------------------------------
    // Wait for the DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', () => {
        const themeToggle = document.querySelector('.theme-toggle');
        const sidebar = document.querySelector('.sidebar');
        const sunSVG = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zm224 0a128 128 0 1 0 -256 0 128 128 0 1 0 256 0z"></path>
            </svg>
        `;
        const moonSVG = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                <path d="M223.5 32C100 32 0 132.3 0 256S100 480 223.5 480c60.6 0 115.5-24.2 155.8-63.4c5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6c-96.9 0-175.5-78.8-175.5-176c0-65.8 36-123.1 89.3-153.3c6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"></path>
            </svg>
        `;

        // Check the saved theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.classList.toggle('dark-mode', savedTheme === 'dark');
            themeToggle.innerHTML = savedTheme === 'dark' ? moonSVG : sunSVG;
            sidebar.classList.toggle('dark-mode', savedTheme === 'dark');
        } else {
            // Default to light theme if no saved preference
            themeToggle.innerHTML = sunSVG;
        }

        // Add click event to toggle theme
        themeToggle.addEventListener('click', () => {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            themeToggle.innerHTML = isDarkMode ? moonSVG : sunSVG;
            sidebar.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        });
    });

    // ----------------------------------------
    // Add a clickable '#' for each heading 
    // that directs to that heading
    // ----------------------------------------
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(header => {
            if (!header.id) {
                let text = header.textContent.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]/g, '');
                header.id = text;
            }

            // Avoid adding duplicate links if the script runs multiple times
            if (!header.querySelector(".headerlink")) {
                let link = document.createElement("a");
                link.className = "headerlink";
                link.href = `#${header.id}`;
                link.title = "Link to this heading";
                link.textContent = " #"; // Space before # for spacing

                header.appendChild(link);
            }
        });
    });

</script>

<!------------------------ #
# Code syntax highlighting #
# ------------------------->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />

<script>
    // Remove the leading whitespace/newlines around code blocks 
    // caused by the html structure used for readability
    document.addEventListener("DOMContentLoaded", function() {
        // Select all code blocks
        const codeBlocks = document.querySelectorAll('.code-cell code.language-python');

        codeBlocks.forEach(function(block) {
            // Apply syntax highlighting to the code block
            // Note: The below line is not needed with this setup
            //  but may be useful in the case that the method
            //  is later changed
            // Prism.highlightElement(block);

            // Get the code with highlighted classes
            const highlightedHTML = block.innerHTML;

            // Remove leading/trailing whitespace/newlines
            block.innerHTML = highlightedHTML.trim();
        });

        // Select all output-code blocks
        const outputBlocks = document.querySelectorAll('.output-cell .output-code');

        outputBlocks.forEach(function(block) {
            // Remove unwanted leading/trailing whitespace or newlines
            block.textContent = block.textContent.trim();
        });
    });
</script>

<!------------------------- #
# Copy button on code cells #
# -------------------------->
<script>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll('.code-cell').forEach(cell => {
        // Avoid inserting the button multiple times
        if (cell.querySelector('.copy-button')) return;

        const button = document.createElement('button');
        button.className = 'copy-button';

        // Define copy icon and text
        button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 0.25em;">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span>Copy</span>
        `;

        // copy text and add click effects
        button.addEventListener('click', () => {
            // const code = cell.innerText;
            const code = cell.querySelector('code').innerText;
            navigator.clipboard.writeText(code).then(() => {
                button.querySelector('span').textContent = 'Copied!';
                setTimeout(() => {
                    button.querySelector('span').textContent = 'Copy';
                }, 1000);
            });
        });

        cell.appendChild(button);
    });
});

</script>

</body>
</html>